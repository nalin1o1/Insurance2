{% extends "base.html" %}

{% block title %}Review Claim - Insurance Portal{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="mb-3">
            <a href="{{ url_for('agent_dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-file-earmark-text"></i> Claim Review
                    </h3>
                    {% if claim.status == 'Pending' %}
                        <span class="badge bg-warning fs-6">{{ claim.status }}</span>
                    {% elif claim.status == 'Approved' %}
                        <span class="badge bg-success fs-6">{{ claim.status }}</span>
                    {% elif claim.status == 'Rejected' %}
                        <span class="badge bg-danger fs-6">{{ claim.status }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="text-muted mb-1">Reference ID</h6>
                            <h5>
                                <span class="badge bg-dark">{{ claim.reference_id }}</span>
                            </h5>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <h6 class="text-muted mb-1">Customer</h6>
                            <h5>{{ claim.user.username }} ({{ claim.user.email }})</h5>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="bi bi-shield"></i> Policy Type
                            </h6>
                            <p class="h5">{{ claim.policy_type }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="bi bi-currency-rupee"></i> Claim Amount
                            </h6>
                            <p class="h5 text-success">â‚¹{{ "{:,.2f}".format(claim.claim_amount) }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <h6 class="text-muted mb-1">
                                <i class="bi bi-calendar"></i> Submitted On
                            </h6>
                            <p>{{ claim.submitted_at.strftime('%B %d, %Y') }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-card-text"></i> Claim Description
                    </h6>
                    <div class="p-3 bg-light rounded">
                        <p class="mb-0">{{ claim.description }}</p>
                    </div>
                </div>
                
                {% if claim.document_path %}
                <div class="mb-3">
                    <h6 class="text-muted mb-2">
                        <i class="bi bi-paperclip"></i> Supporting Documents
                    </h6>
                    <div class="alert alert-success">
                        <i class="bi bi-file-earmark-check"></i> 
                        Document uploaded: <strong>{{ claim.document_path }}</strong>
                    </div>
                </div>
                {% endif %}
                
                {% if claim.status != 'Pending' %}
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="bi bi-info-circle"></i> Review Information
                    </h6>
                    <p class="mb-1"><strong>Status:</strong> {{ claim.status }}</p>
                    <p class="mb-1"><strong>Reviewed by:</strong> {{ claim.reviewed_by_agent.username if claim.reviewed_by_agent else 'N/A' }}</p>
                    <p class="mb-1"><strong>Review Notes:</strong></p>
                    <p class="mb-0">{{ claim.review_notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if claim.status == 'Pending' %}
        <div class="card">
            <div class="card-header bg-white">
                <h4 class="mb-0">
                    <i class="bi bi-clipboard-check"></i> Review & Decision
                </h4>
            </div>
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('agent_review_claim', reference_id=claim.reference_id) }}">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-4">
                        <label for="action" class="form-label">
                            <i class="bi bi-hand-thumbs-up"></i> Decision <span class="text-danger">*</span>
                        </label>
                        {{ form.action(class="form-select form-select-lg") }}
                        {% if form.action.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.action.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label for="review_notes" class="form-label">
                            <i class="bi bi-chat-left-text"></i> Review Notes <span class="text-danger">*</span>
                        </label>
                        {{ form.review_notes(class="form-control", rows="5", placeholder="Provide detailed notes for your decision (minimum 10 characters)") }}
                        <small class="text-muted">Explain the reason for approval or rejection</small>
                        {% if form.review_notes.errors %}
                            <div class="text-danger mt-1">
                                {% for error in form.review_notes.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                            <i class="bi bi-check-circle"></i> Submit Review
                        </button>
                        <a href="{{ url_for('agent_dashboard') }}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}